testcase: "TC-DATABASE-VERIFY"
description: "Database test with data verification"

variables:
  vars:
    db_url: "postgres://robogo_testuser:robogo_testpass@localhost:5432/robogo_testdb?sslmode=disable"
    user_name: "Alice Smith"
    user_email: "alice@test.com"
    user_age: "30"

steps:
  # Setup test table
  - name: "Create test table with multiple columns"
    action: postgres
    args: ["execute", "${db_url}", "CREATE TABLE IF NOT EXISTS test_users (id SERIAL PRIMARY KEY, name VARCHAR(100), email VARCHAR(100), age INTEGER, created_at TIMESTAMP DEFAULT NOW())"]

  # Insert test data
  - name: "Insert user with multiple fields"
    action: postgres
    args: ["execute", "${db_url}", "INSERT INTO test_users (name, email, age) VALUES ('${user_name}', '${user_email}', ${user_age}) RETURNING id"]
    result: "insert_result"

  # Query back the inserted data
  - name: "Query inserted user by email"
    action: postgres
    args: ["query", "${db_url}", "SELECT id, name, email, age FROM test_users WHERE email = '${user_email}'"]
    result: "user_data"

  # Extract user data with jq
  - name: "Extract user ID with jq"
    action: jq
    args: ["${user_data}", ".rows[0][0]"]
    result: "user_id"

  - name: "Extract retrieved name with jq"
    action: jq
    args: ["${user_data}", ".rows[0][1]"]
    result: "retrieved_name"

  - name: "Extract retrieved email with jq"
    action: jq
    args: ["${user_data}", ".rows[0][2]"]
    result: "retrieved_email"

  - name: "Extract retrieved age with jq"
    action: jq
    args: ["${user_data}", ".rows[0][3]"]
    result: "retrieved_age"

  # Verify all the data matches what we inserted
  - name: "Verify name matches"
    action: assert
    args: ["${retrieved_name}", "==", "${user_name}", "Name should match inserted value"]

  - name: "Verify email matches"
    action: assert
    args: ["${retrieved_email}", "==", "${user_email}", "Email should match inserted value"]

  - name: "Verify age matches"
    action: assert
    args: ["${retrieved_age}", "==", "${user_age}", "Age should match inserted value"]

  - name: "Verify user ID is valid"
    action: assert
    args: ["${user_id}", "!=", "", "User ID should not be empty"]

  # Test UPDATE operation
  - name: "Update user age"
    action: postgres
    args: ["execute", "${db_url}", "UPDATE test_users SET age = 31 WHERE id = ${user_id}"]
    result: "update_result"

  - name: "Extract rows affected with jq"
    action: jq
    args: ["${update_result}", ".rows_affected"]
    result: "rows_affected"

  - name: "Verify update affected one row"
    action: assert
    args: ["${rows_affected}", "==", "1", "Update should affect exactly 1 row"]

  # Verify the update worked
  - name: "Query updated user"
    action: postgres
    args: ["query", "${db_url}", "SELECT age FROM test_users WHERE id = ${user_id}"]
    result: "updated_data"

  - name: "Extract updated age with jq"
    action: jq
    args: ["${updated_data}", ".rows[0][0]"]
    result: "new_age"

  - name: "Verify age was updated"
    action: assert
    args: ["${new_age}", "==", "31", "Age should be updated to 31"]

  # Test aggregate functions
  - name: "Count users"
    action: postgres
    args: ["query", "${db_url}", "SELECT COUNT(*) FROM test_users"]
    result: "count_data"

  - name: "Extract user count with jq"
    action: jq
    args: ["${count_data}", ".rows[0][0]"]
    result: "total_users"

  - name: "Verify we have at least our test user"
    action: assert
    args: ["${total_users}", "!=", "0", "Should have at least 1 user"]

  # Cleanup
  - name: "Delete test user"
    action: postgres
    args: ["execute", "${db_url}", "DELETE FROM test_users WHERE id = ${user_id}"]

  - name: "Log successful completion"
    action: log
    args: ["Database verification test completed successfully!"]