testcase: "Postgres Integration Test"
description: "Integration test for Bitnami Postgres using RoboGo. Creates a table, inserts data, queries, asserts, and cleans up."

variables:
  secrets:
    db_password:
      file: "db_secret.txt"
      mask_output: true
  vars:
    db_host: "localhost"
    db_port: "5432"
    db_name: "robogo_testdb"
    db_user: "robogo_testuser"
    test_table: "integration_test"
    pg_url: "postgresql://${db_user}:${SECRETS.db_password}@${db_host}:${db_port}/${db_name}?sslmode=disable"

steps:

  - name: "Connect to Postgres"
    action: postgres
    args: ["connect", "${pg_url}"]
    result: conn
    description: "Connect to Postgres"

  - name: "Create test table"
    action: postgres
    args: ["execute", "${pg_url}", "CREATE TABLE IF NOT EXISTS ${test_table} (id SERIAL PRIMARY KEY, name TEXT)"]
    description: "Create test table"

  - name: "Insert a row"
    action: postgres
    args: ["execute", "${pg_url}", "INSERT INTO ${test_table} (name) VALUES ('robogo')"]
    description: "Insert a row"

  - name: "Query the inserted row"
    action: postgres
    args: ["query", "${pg_url}", "SELECT name FROM ${test_table} WHERE name = 'robogo'"]
    result: query_result
    description: "Query the inserted row"

  - name: "Clean up: drop test table"
    action: postgres
    args: ["execute", "${pg_url}", "DROP TABLE IF EXISTS ${test_table}"]
    description: "Clean up: drop test table" 